// This file is automatically generated. Do not edit it directly.
import { createClient } from "@supabase/supabase-js";
import type { Database } from "./types";

/**
 * Supabase Auth (by default) uses a fixed key in localStorage which makes the
 * session global to all tabs for the same origin. The product requirement now
 * is to allow logging into DIFFERENT accounts concurrently in separate tabs.
 *
 * Approach:
 *  - Use a per-tab storage key derived from a tab-specific ID kept in
 *    sessionStorage (which is scoped to the lifetime of the tab).
 *  - Store the session itself in sessionStorage instead of localStorage so it
 *    is NOT shared across tabs. (Reloads in the same tab retain the session.)
 *  - Each tab therefore initializes its own Supabase client + auth state.
 *
 * Consequences / Notes:
 *  - Closing a tab forgets that tab's session (intended for isolation).
 *  - A sign-out in one tab will NOT sign out other tabs (also intended).
 *  - If you ever want the old shared-session behavior, revert storage to
 *    localStorage and remove the dynamic storageKey logic.
 */

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_ANON_KEY =
  import.meta.env.VITE_SUPABASE_ANON_KEY ||
  import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  throw new Error(
    "Supabase environment variables are missing. Check your .env configuration."
  );
}

// Generate or retrieve a stable per-tab id (persists across reloads, not across new tab instances)
function getTabId(): string {
  if (typeof window === "undefined") return "server";
  try {
    const existing = window.sessionStorage.getItem("QB_TAB_ID");
    if (existing) return existing;
    const id =
      window.crypto?.randomUUID?.() || Math.random().toString(36).slice(2);
    window.sessionStorage.setItem("QB_TAB_ID", id);
    return id;
  } catch {
    // Fallback if sessionStorage not available (shouldn't happen in normal browser usage)
    return "fallback";
  }
}

const TAB_ID = getTabId();
const STORAGE_KEY = `sb-${TAB_ID}-auth`; // unique per tab

// Provide a storage adapter (Supabase expects the Storage interface of Web Storage)
const storage =
  typeof window !== "undefined" ? window.sessionStorage : undefined;

export const supabase = createClient<Database>(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  {
    auth: {
      storage,
      storageKey: STORAGE_KEY,
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
    },
  }
);
